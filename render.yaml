services:
  # ───────── Web UI & API ─────────
  - type: web
    name: pitext-email
    env: docker
    plan: standard
    dockerfilePath: ./docker/app/Dockerfile
    pullRequestPreviewsEnabled: true
    autoDeploy: true
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"
      # Build environment variables
      - key: CI
        value: "true"
      - key: VITE_BUILD_MODE
        value: "production"
      # Google OAuth (for Gmail import)
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      # Auth Secret
      - key: BETTER_AUTH_SECRET
        sync: false
      # URLs (pointing to self)
      - key: VITE_PUBLIC_APP_URL
        value: https://pitext-email.onrender.com
      - key: VITE_PUBLIC_BACKEND_URL
        value: https://pitext-email.onrender.com
      - key: BETTER_AUTH_URL
        value: https://pitext-email.onrender.com
      # Additional environment variables
      - key: NEXTAUTH_SECRET
        sync: false
      - key: LLM_MODEL
        value: "gpt-4.1"
      - key: LLM_PROXY_URL
        sync: false

  # ───────── Background worker (Gmail sync, etc.) ─────────
  - type: worker
    name: pitext-email-worker
    env: docker
    plan: standard
    dockerfilePath: ./docker/app/Dockerfile
    startCommand: cd apps/server && node server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: BETTER_AUTH_SECRET
        sync: false
      - key: LLM_MODEL
        value: "gpt-4.1"
      - key: LLM_PROXY_URL
        sync: false

  # ───────── Cron job for Gmail watch renewal ─────────
  - type: cron
    name: pitext-email-cron
    env: docker
    schedule: "0 */6 * * *"
    dockerfilePath: ./docker/app/Dockerfile
    startCommand: cd apps/server && node jobs/renew-watch.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: BETTER_AUTH_SECRET
        sync: false 